<!DOCTYPE HTML>
<html>
<head>
    <!-- support for mobile touch devices -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1, minimal-ui">
    <link href="css/bootstrap/theme.css" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link href="css/cornerstone.min.css" rel="stylesheet">
    <link href="css/cornerstone_viewer.css" rel="stylesheet">
</head>
<body>
<div id="wrap">
    <div class='main'>
        <ul id="tabs" class="nav nav-tabs" >
            <li class="active"><a href="#studyList" data-toggle="tab">Study List</a></li>
        </ul>

        <div id="tabContent" class="tab-content">
            <div id="studyList" class="tab-pane active">
                <div class="row">
                    <table id="mytable" class="col-md-12 table table-striped table-hover">
                        <thead>
                        <tr>
                            <th>Patient Name</th>
                            <th>Patient ID</th>
                            <th>Study Date</th>
                            <th>Modality</th>
                            <th>Study Description</th>
                            <th># Images</th>
                        </tr>
                        </thead>
                        <tbody id="studyListData" style="cursor: pointer">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="studyViewerTemplate" class="tab-pane active hidden" style="height:100%">
            <div class="studyContainer" style="height:100%">
                <div class="studyRow row" style="height:100%">
                    <div class="thumbnailSelector">
                        <div class="thumbnails list-group">
                        </div>
                    </div>
                    <div class="viewer">
                        <div class="text-center" >
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="WW/WC"><span class="fa fa-sun-o"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Invert"><span class="fa fa-adjust"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Zoom"><span class="fa fa-search"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Pan"><span class="fa fa-arrows"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Stack Scroll"><span class="fa fa-bars"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Length Measurement"><span class="fa fa-arrows-v"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Pixel Probe"><span class="fa fa-dot-circle-o"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Elliptical ROI"><span class="fa fa-circle-o"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Rectangle ROI"><span class="fa fa-square-o"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Play Clip"><span class="fa fa-play"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Stop Clip"><span class="fa fa-stop"></span></button>
                            </div>
                        </div>
                        <div class="imageViewer">
                            <div class="viewportWrapper" style="width:100%;height:100%;position:relative;color: white;display:inline-block;background-color:black;"
                                 oncontextmenu="return false"
                                 class='cornerstone-enabled-image'
                                 unselectable='on'
                                 onselectstart='return false;'
                                 onmousedown='return false;'>
                                <div class="viewport">
                                </div>
                                <div class="overlay" style="top:0px; left:0px">
                                    <div>Patient Name</div>
                                    <div>Patient Id</div>
                                </div>
                                <div class="overlay" style="top:0px; right:0px">
                                    <div>Study Description</div>
                                    <div>Study Date</div>
                                </div>

                                <div class="overlay" style="bottom:0px; left:0px">
                                    <div class="fps">FPS:</div>
                                    <div class="renderTime">Render Time:</div>
                                    <div class="currentImageAndTotalImages">Image #:</div>
                                </div>
                                <div class="overlay" style="bottom:0px; right:0px">
                                    <div>Zoom:</div>
                                    <div>WW/WC:</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
             </div>
        </div>
    </div>
</div>

<div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Help</h4>
            </div>
            <div class="modal-body">
                <ol>
                    <li>Select a study in the study list to view its images, a new tab will be created for each study.</li>
                    <li>Interact with the image using your mouse: left click drag - ww/wl, middle click drag - pan, right click drag - zoom, mouse wheel - scroll through stack</li>
                    <li>Select another series to display by left click the series list on the left</li>
                    <li>Select another tool to use with the left mouse button by selecting the tool button</li>
                </ol>
                <br>
                This demo requires a HTML5 browser, Google Chrome is recommended.
                <br>
             </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>

<!-- include the hammer.js library for touch gestures-->
<script src="js/external/jquery.hammer-full.js"></script>

<script src="js/external/bootstrap.min.js" ></script>

<!-- include the cornerstone library -->
<script src="js/external/cornerstone.min.js"></script>

<!-- include the cornerstone library -->
<script src="js/external/cornerstoneMath.min.js"></script>

<!-- include the cornerstone tools library -->
<script src="js/external/cornerstoneTools.min.js"></script>

<!-- include the cornerstoneWADOImageLoader library -->
<script src="js/external/cornerstoneWADOImageLoader.min.js"></script>

<script src="js/external/cornerstoneWebImageLoader.min.js"></script>

<!-- include the dicomParser library -->
<script src="js/external/dicomParser.min.js"></script>

    <script>

    $('#tabs a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
    });

    function loadStudyJson(studyViewer, studyId)
    {
        $.getJSON('studies/' + studyId, function(data) {
            // Load the first series into the viewport
            $('#wadoURL').val();

            var stacks = [];
            var currentStackIndex = 0;
            var seriesIndex = 0;
            data.seriesList.forEach(function(series) {
                var stack = {
                    seriesDescription: series.seriesDescription,
                    stackId : series.seriesNumber,
                    imageIds: [],
                    seriesIndex : seriesIndex,
                    currentImageIdIndex: 0,
                    frameRate: series.frameRate
                }
                if(series.numberOfFrames !== undefined) {
                    var numberOfFrames = series.numberOfFrames;
                    for(var i=0; i < numberOfFrames; i++) {
                        var imageId = series.instanceList[0].imageId + "?frame=" + i;
                        // http request is for jpeg and other raw image formats
                        if(imageId.substr(0, 4) !== 'http') {
                            imageId = "dicomweb://data.semantic.md/dicom_test_data/" + imageId;
                        }
                        stack.imageIds.push(imageId);
                    }
                } else {
                    series.instanceList.forEach(function(image) {
                        var imageId = image.imageId;
                        // http request is for jpeg and other raw image formats
                        if(image.imageId.substr(0, 4) !== 'http') {
                            imageId = "dicomweb://data.semantic.md/dicom_test_data/" + image.imageId;
                        }
                        stack.imageIds.push(imageId);
                    });

                }
                seriesIndex++;
                stacks.push(stack);
            });

            // resize the parent div of the viewport to fit the screen
            var imageViewer = $(studyViewer).find('.imageViewer')[0];
            var viewportWrapper = $(imageViewer).find('.viewportWrapper')[0];
            var parentDiv = $(studyViewer).find('.viewer')[0];
            viewportWrapper.style.width = (parentDiv.style.width - 10) + "px";
            viewportWrapper.style.height= (window.innerHeight - 150) + "px";

            var studyRow = $(studyViewer).find('.studyRow')[0];
            var width = $(studyRow).width();
            $(parentDiv).width(width - 170);
            viewportWrapper.style.width = (parentDiv.style.width - 10) + "px";
            viewportWrapper.style.height= (window.innerHeight - 150) + "px";

            // image enable the dicomImage element and activate a few tools
            var element = $(studyViewer).find('.viewport')[0];
            var parent = $(element).parent();
            var childDivs = $(parent).find('.overlay');
            var topLeft = $(childDivs[0]).find('div');
            $(topLeft[0]).text(data.patientName);
            $(topLeft[1]).text(data.patientId);
            var topRight= $(childDivs[1]).find('div');
            $(topRight[0]).text(data.studyDescription);
            $(topRight[1]).text(data.studyDate);
            var bottomLeft = $(childDivs[2]).find('div');
            var bottomRight = $(childDivs[3]).find('div');

            function onNewImage(e) {
                // if we are currently playing a clip then update the FPS
                var playClipToolData = cornerstoneTools.getToolState(element, 'playClip');
                if(playClipToolData !== undefined && playClipToolData.data.length > 0 && playClipToolData.data[0].intervalId !== undefined && e.detail.frameRate !== undefined) {
                    $(bottomLeft[0]).text("FPS: " + Math.round(e.detail.frameRate));
                    //console.log('frameRate: ' + e.detail.frameRate);
                } else {
                    if($(bottomLeft[0]).text().length > 0) {
                        $(bottomLeft[0]).text("");
                    }
                }
                $(bottomLeft[2]).text("Image #" + (stacks[currentStackIndex].currentImageIdIndex + 1) + "/" + stacks[currentStackIndex].imageIds.length);
            }
            element.addEventListener("CornerstoneNewImage", onNewImage, false);

            function onImageRendered(e) {
                $(bottomRight[0]).text("Zoom:" + e.detail.viewport.scale.toFixed(2));
                $(bottomRight[1]).text("WW/WL:" + Math.round(e.detail.viewport.voi.windowWidth) + "/" + Math.round(e.detail.viewport.voi.windowCenter));
                $(bottomLeft[1]).text("Render Time:" + e.detail.renderTimeInMs + " ms");
            }
            element.addEventListener("CornerstoneImageRendered", onImageRendered, false);


            var imageId = stacks[currentStackIndex].imageIds[0];

            // image enable the dicomImage element
            cornerstone.enable(element);
                        cornerstone.loadAndCacheImage(imageId).then(function(image) {
                cornerstone.displayImage(element, image);
                if(stacks[0].frameRate !== undefined) {
                    cornerstone.playClip(element, stacks[0].frameRate);
                }

                cornerstoneTools.mouseInput.enable(element);
                cornerstoneTools.mouseWheelInput.enable(element);
                cornerstoneTools.touchInput.enable(element);

                // Enable all tools we want to use with this element
                cornerstoneTools.wwwc.activate(element, 1); // ww/wc is the default tool for left mouse button
                cornerstoneTools.pan.activate(element, 2); // pan is the default tool for middle mouse button
                cornerstoneTools.zoom.activate(element, 4); // zoom is the default tool for right mouse button
                cornerstoneTools.probe.enable(element);
                cornerstoneTools.length.enable(element);
                cornerstoneTools.ellipticalRoi.enable(element);
                cornerstoneTools.rectangleRoi.enable(element);
                cornerstoneTools.wwwcTouchDrag.activate(element);
                cornerstoneTools.zoomTouchPinch.activate(element);


                // stack tools
                cornerstoneTools.addStackStateManager(element, ['playClip']);
                cornerstoneTools.addToolState(element, 'stack', stacks[0]);
                cornerstoneTools.stackScrollWheel.activate(element);
                cornerstoneTools.stackPrefetch.enable(element);


                function disableAllTools()
                {
                    cornerstoneTools.wwwc.disable(element);
                    cornerstoneTools.pan.activate(element, 2); // 2 is middle mouse button
                    cornerstoneTools.zoom.activate(element, 4); // 4 is right mouse button
                    cornerstoneTools.probe.deactivate(element, 1);
                    cornerstoneTools.length.deactivate(element, 1);
                    cornerstoneTools.ellipticalRoi.deactivate(element, 1);
                    cornerstoneTools.rectangleRoi.deactivate(element, 1);
                    cornerstoneTools.stackScroll.deactivate(element, 1);
                    cornerstoneTools.wwwcTouchDrag.deactivate(element);
                    cornerstoneTools.zoomTouchDrag.deactivate(element);
                    cornerstoneTools.panTouchDrag.deactivate(element);
                    cornerstoneTools.stackScrollTouchDrag.deactivate(element);
                }

                var buttons = $(studyViewer).find('button');
                // Tool button event handlers that set the new active tool
                $(buttons[0]).on('click touchstart',function() {
                    disableAllTools();
                    cornerstoneTools.wwwc.activate(element, 1);
                    cornerstoneTools.wwwcTouchDrag.activate(element);
                });
                $(buttons[1]).on('click touchstart',function() {
                    disableAllTools();
                    var viewport = cornerstone.getViewport(element);
                    if(viewport.invert === true) {
                        viewport.invert = false;
                    }
                    else {
                        viewport.invert = true;
                    }
                    cornerstone.setViewport(element, viewport);
                });
                $(buttons[2]).on('click touchstart',function() {
                    disableAllTools();
                    cornerstoneTools.zoom.activate(element, 5); // 5 is right mouse button and left mouse button
                    cornerstoneTools.zoomTouchDrag.activate(element);
                });
                $(buttons[3]).on('click touchstart',function() {
                    disableAllTools();
                    cornerstoneTools.pan.activate(element, 3); // 3 is middle mouse button and left mouse button
                    cornerstoneTools.panTouchDrag.activate(element);
                });
                $(buttons[4]).on('click touchstart',function() {
                    disableAllTools();
                    cornerstoneTools.stackScroll.activate(element, 1);
                    cornerstoneTools.stackScrollTouchDrag.activate(element);
                });
                $(buttons[5]).on('click touchstart',function() {
                    disableAllTools();
                    cornerstoneTools.length.activate(element, 1);
                });
                $(buttons[6]).on('click touchstart',function() {
                    disableAllTools();
                    cornerstoneTools.probe.activate(element, 1);
                });
                $(buttons[7]).on('click touchstart',function() {
                    disableAllTools();
                    cornerstoneTools.ellipticalRoi.activate(element, 1);
                });
                $(buttons[8]).on('click touchstart',function() {
                    disableAllTools();
                    cornerstoneTools.rectangleRoi.activate(element, 1);
                });
                $(buttons[9]).on('click touchstart',function() {
                    var frameRate = stacks[currentStackIndex].frameRate;
                    if(frameRate === undefined) {
                        frameRate = 10;
                    }
                    cornerstoneTools.playClip(element, 31);
                });
                $(buttons[10]).on('click touchstart',function() {
                    cornerstoneTools.stopClip(element);
                });
                $(buttons[0]).tooltip();
                $(buttons[1]).tooltip();
                $(buttons[2]).tooltip();
                $(buttons[3]).tooltip();
                $(buttons[4]).tooltip();
                $(buttons[5]).tooltip();
                $(buttons[6]).tooltip();
                $(buttons[7]).tooltip();
                $(buttons[8]).tooltip();
                $(buttons[9]).tooltip();

                var seriesList = $(studyViewer).find('.thumbnails')[0];
                stacks.forEach(function(stack) {
                    var seriesEntry = '<a class="list-group-item" + ' +
                            'oncontextmenu="return false"' +
                        'unselectable="on"' +
                        'onselectstart="return false;"' +
                        'onmousedown="return false;">' +
                                '<div class="csthumbnail"' +
                            'oncontextmenu="return false"' +
                            'unselectable="on"' +
                            'onselectstart="return false;"' +
                            'onmousedown="return false;"></div>' +
                            "<div class='text-center small'>" + stack.seriesDescription + '</div></a>';
                    var seriesElement = $(seriesEntry).appendTo(seriesList);
                    var thumbnail = $(seriesElement).find('div')[0];
                    cornerstone.enable(thumbnail);
                    cornerstone.loadAndCacheImage(stacks[stack.seriesIndex].imageIds[0]).then(function(image) {
                        if(stack.seriesIndex === 0) {
                            $(seriesElement).addClass('active');
                        }
                        cornerstone.displayImage(thumbnail, image);

                    });
                    $(seriesElement).on('click touchstart', function () {
                        // make this series visible
                        var activeThumbnails = $(seriesList).find('a').each(function() {
                            $(this).removeClass('active');
                        });
                        $(seriesElement).addClass('active');

                        cornerstoneTools.stopClip(element);
                        cornerstoneTools.stackScroll.disable(element);
                        cornerstoneTools.stackScroll.enable(element, stacks[stack.seriesIndex], 0);
                        cornerstone.loadAndCacheImage(stacks[stack.seriesIndex].imageIds[0]).then(function(image) {
                            var defViewport = cornerstone.getDefaultViewport(element, image);
                            currentStackIndex = stack.seriesIndex;
                            cornerstone.displayImage(element, image, defViewport);
                            cornerstone.fitToWindow(element);
                            var stackState = cornerstoneTools.getToolState(element, 'stack');
                            stackState.data[0] = stacks[stack.seriesIndex];
                            stackState.data[0].currentImageIdIndex = 0;
                            cornerstoneTools.stackPrefetch.enable(element);
                            $(bottomLeft[1]).text("# Images: " + stacks[stack.seriesIndex].imageIds.length);

                            if(stacks[stack.seriesIndex].frameRate !== undefined) {
                                cornerstoneTools.playClip(element, stacks[stack.seriesIndex].frameRate);
                            }
                        });
                    });


                });

                function resizeStudyViewer() {
                    var studyRow = $(studyViewer).find('.studyRow')[0];
                    var height = $(studyRow).height();
                    var width = $(studyRow).width();
                    $(seriesList).height(height - 40);
                    $(parentDiv).width(width - 170);
                    viewportWrapper.style.width = (parentDiv.style.width - 10) + "px";
                    viewportWrapper.style.height= (window.innerHeight - 150) + "px";
                    cornerstone.resize(element, true);
                }

                $(window).resize(function() {
                    resizeStudyViewer();
                });
                resizeStudyViewer();

            });

        });
    }

    function resizeMain() {
        var height = $(window).height();
        $('#main').height(height - 50);
        $('#tabContent').height(height - 50 -42);
    }

    $(window).resize(function() {
        resizeMain();
    });
    resizeMain();


    $.getJSON('study_list_misc.json', function(data)
    {
        data.studyList.forEach(function(study) {
            var studyRow = '<tr><td>' +
                    study.patientName + '</td><td>' +
                    study.patientId + '</td><td>' +
                    study.studyDate + '</td><td>' +
                    study.modality + '</td><td>' +
                    study.studyDescription + '</td><td>' +
                    study.numImages + '</td><td>' +
                    '</tr>';
             var studyRowElement = $(studyRow).appendTo('#studyListData');
            $(studyRowElement).click(function() {
                // Add new tab for this study and switch to it
                var studyTab = '<li><a href="#x' + study.patientId + '" data-toggle="tab">' + study.patientName + '</a></li>';
                $('#tabs').append(studyTab);

                var id_val = 0;

                if (study.patientName === "Meda D. Torres") {
                    id_val = 2;
                } 

                if (study.patientName === "Maria M. Haas") {
                    id_val = 1;
                } 

                if (study.patientName === "Angelique C. Venne") {
                    id_val = 3;
                } 

                if (study.patientName === "John N. Harrison") {
                    id_val = 4;
                } 

                // add tab content by making a copy of the studyViewerTemplate element
                var studyViewerCopy = $('#studyViewerTemplate').clone();
                studyViewerCopy.attr("id", 'x' + study.patientId);
                studyViewerCopy.removeClass('hidden');
                studyViewerCopy.appendTo('#tabContent');

                // show the new tab (which will be the last one since it was just added
                $('#tabs a:last').tab('show');

                $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                    $(window).trigger('resize');
                });

                // Now load the study.json
                loadStudyJson(studyViewerCopy, study.studyId + ".json");
            });
        });



    });

    $("#help").click(function() {
        $("#helpModal").modal();
    });

    $("#about").click(function() {
        $("#aboutModal").modal();
    });


    // prevent scrolling on ios
    document.body.addEventListener('touchmove', function(e){ e.preventDefault(); });


</script>

</body>
</html>
